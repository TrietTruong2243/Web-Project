<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

    <style>
        #dg-chat-iframe {
            position: absolute;
            opacity: 0;
            width: 1px;
            height: 1px;
            top: 0;
            left: 0;
            border: none;
            display: block;
            z-index: -1;
            pointer-events: none;
        }

        #dg-chat-container {
            position: relative;
            z-index: 2147483647;
        }

        #dg-chat-widget {
            position: fixed;
            width: 100%;
            right: 20px;
            bottom: 20px;
            max-width: 375px;
            height: 90%;
            max-height: 650px;
            min-height: 570px;
            box-shadow: rgb(0 0 0 / 12%) 0 12px 48px 4px;
            border-radius: 16px;
            overflow: hidden;
        }

        .navBar-item {
            cursor: pointer;
        }

        .is-active {
            margin: 2px;
            padding: 2px;
            background-color: white;
        }

        @media only screen and (max-width: 800px) {
            #dg-chat-widget {
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;
                height: 100%;
                width: 100%;
                max-width: initial;
                max-height: initial;
                border-radius: 0;
            }
        }

        #dg-chat-widget-launcher {
            position: fixed;
            right: 20px;
            bottom: 20px;
            height: 65px;
            width: 65px;
        }

        #dg-chat-widget-proactive {
            position: fixed;
            right: 20px;
            bottom: 90px;
        }

        .form-label {

            text-align: left;
        }
    </style>
    <style type="text/css">
        body {
            background: #e6e6e6;
        }

        .card {
            box-shadow: 0 20px 27px 0 rgb(0 0 0 / 5%);
        }

        .card {
            position: relative;
            display: flex;
            flex-direction: column;
            min-width: 0;
            word-wrap: break-word;
            background-color: #fff;
            background-clip: border-box;
            border: 0 solid rgba(0, 0, 0, .125);
            border-radius: 1rem;
        }

        .text-reset {
            --bs-text-opacity: 1;
            color: inherit !important;
        }

        a {
            color: #5465ff;
            text-decoration: none;
        }
    </style>
    <style>
        .status span {
            position: relative;
            border-radius: 30px;
            padding: 4px 10px 4px 25px;
        }

        .status span:after {
            position: absolute;
            top: 9px;
            left: 10px;
            width: 10px;
            height: 10px;
            content: '';
            border-radius: 50%;
        }

        .status .Done {
            background: #cff6dd;
            color: #1fa750;
        }

        .status .Done:after {
            background: #23bd5a;
        }

        .status .Processing {
            background: #fdf5dd;
            color: #cfa00c;
        }

        .status .Processing:after {
            background: #f2be1d;
        }

        .status .Waiting {
            background: #fdf5dd;
            color: #cfa00c;
        }

        .status .Waiting:after {
            background: #f2be1d;
        }

        /* red */
        .status .cancelled {
            background: #f2481d88;
            color: #ff2600;
        }

        .status .cancelled:after {
            background: #f73200;
        }

        .status .refunded {
            background: #f2481d88;
            color: #ff2600;
        }

        .status .refunded:after {
            background: #f73200;
        }

        /* yellow */


        .status .Waiting {
            background: #fdf5dd;
            color: #cfa00c;
        }

        .status .Waiting:after {
            background: #f2be1d;
        }

        .status .pending {
            background: #fdf5dd;
            color: #cfa00c;
        }

        .status .pending:after {
            background: #f2be1d;
        }

        .status .unpaid {
            background: #fdf5dd;
            color: #cfa00c;
        }

        .status .unpaid:after {
            background: #f2be1d;
        }

        .status .confirmed {
            background: #fdf5dd;
            color: #cfa00c;
        }

        .status .confirmed:after {
            background: #f2be1d;
        }

        .status .shipping {
            background: #91e5f2;
            color: #06aac4;
        }

        .status .shipping:after {
            background: #06aac4;
        }



        /* Green */

        .status .completed {
            background: #cff6dd;
            color: #1fa750;
        }

        .status .completed:after {
            background: #23bd5a;
        }
    </style>

    <title>Order Details</title>
    <style type="text/css">
        #dg-chat-container {
            display: none;
        }

        html {
            background-color: #a8a7a7;

            background-size: cover;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <link rel="icon" type="image/png"
        href="https://cdn.pixabay.com/photo/2017/03/29/04/09/shopping-icon-2184065_1280.png">

    <link type="text/css" rel="stylesheet" href="/resource/theme-8c4df980-6632-013c-f3de-5e0f1ae9fa0d.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

</head>

<body class="productlanding US_EN  cookie-message-active   pace-done" id="productlanding">
    {{> headers/page_header}}
    <!-- body -->

    <div class="body" id="main-content">
        <div class="body-inner">
            <div class="body-content " style="background-color: rgb(168, 167, 167);">
                <div class="container-fluid">
                    <div class="container">
                        <!-- title -->
                        <div class="d-flex justify-content-between align-items-center py-3">
                            <h2 class="h5 mb-0"><a href="#" class="text-muted"></a> Order #{{orderInfo.OrderID}}</h2>
                        </div>

                        <div class="row">
                            <!-- order -->
                            <div class="col-lg-8 ">
                                <!-- order info & detail -->
                                <div class="card">
                                    <div class="card-body">
                                        <div class=" p-3 d-flex justify-content-between border border primary "
                                            style="background-color: black; color:white ">
                                            <div class="status">
                                                <span class="me-3">{{orderInfo.Date}}</span>
                                                <span class="me-3">Order#{{orderInfo.OrderID}} </span>
                                                <span class="me-3" id="payment_method"> Cash Settlement </span>
                                                <span class="me-3 {{orderInfo.Status}}">{{orderInfo.Status}}</span>
                                            </div>
                                        </div>
                                        <table class="table " style="margin-top: 2px;">
                                            <tbody>
                                                {{#each orderDetail}}
                                                <tr>
                                                    <td>
                                                        <div class="d-flex mb-2">
                                                            <div class="flex-shrink-0">
                                                                <img src="{{image}}" alt width="35" class="img-fluid">
                                                            </div>
                                                            <div class="flex-lg-grow-1 ms-3">
                                                                <h4 class="small mb-0 mt-1"
                                                                    style="font-weight: 700; font-size:medium">
                                                                    <a href="#" class="text-reset"> {{name}}</a>
                                                                </h4>
                                                                <span class="small">Describe: {{describe}}</span>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td> {{quantity}}</td>
                                                    <td class="text-end">{{price}} đ</td>
                                                </tr>
                                                {{/each}}
                                            </tbody>
                                            <tfoot>
                                                <tr class="fw-bold">
                                                    <td colspan="2">TOTAL</td>
                                                    <td class="text-end">{{orderInfo.Total}} đ</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>

                                <!-- payment & user address -->
                                <div class="card mb-4">
                                    <div class="card-body bg-light rounded-4 p7-0">
                                        <div class="row">

                                            {{#if orderInfo.Check}}
                                            <div class="col-lg-6 text-start ps-5">
                                                <h3 class="h6 mt-2 mb-3">Payment Status </h3>
                                                <p class="my-1 ps-1">
                                                    Total: {{orderInfo.Total}} đ
                                                    {{#if orderInfo.Refund}}
                                                    <span class="badge bg-danger rounded-pill">REFUND</span>
                                                    {{else}}
                                                    {{#if orderInfo.Cancel}}
                                                    <span class="badge bg-danger rounded-pill">CANCEL</span>
                                                    {{else}}
                                                    <span class="badge bg-success rounded-pill">PAID</span>
                                                    {{/if}}
                                                    {{/if}}
                                                </p>
                                            </div>
                                            {{else}}
                                            <div class="col-lg-6 text-start ps-5">
                                                <h3 class="h6 mt-2 mb-2">Payment Method </h3>
                                                <p class="my-1 ps-1">
                                                    <input type="radio" class="mb-0" name="payment-method" id="method-a"
                                                        value="cash" checked="checked">
                                                    <label for="radio-choice-v-6a">Thanh toán bằng tiền mặt</label> <br>
                                                    <input type="radio" class="mb-0" name="payment-method" id="methodb"
                                                        value="transact">
                                                    <label for="radio-choice-v-6b">Chuyển khoản</label> <br>
                                                    Total: {{orderInfo.Total}} đ
                                                    <span class="badge bg-warning rounded-pill">UNPAID</span>
                                                </p>
                                                <button type="button" class="btn btn-primary mt-4" id="payment_btn">
                                                    Pay by <div class="badge bg-success">SkullPay</div>
                                                </button>
                                                <div class="d-none">
                                                    <label for="password">Password for payment account</label>
                                                    <input type="password" name="password" id="password">
                                                    <button id="confirmPayment" class="btn btn-primary mt-4">Confirm</button>
                                                </div>
                                            </div>
                                            {{/if}}

                                            <div class="col-lg-6 text-start ps-5">
                                                <h3 style="font-weight: 700; font-size:medium">Billing address</h3>
                                                <address>
                                                    <strong
                                                        style="font-weight: 500; font-size:medium">{{userInfo.name}}</strong><br>
                                                    <abbr title="Address">Addr:</abbr> {{userInfo.address}}<br>
                                                    <abbr title="Phone Number">P.:</abbr> {{userInfo.phone}}
                                                </address>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- user info -->
                            <div class="col-lg-4 rounded-4">
                                <div class="card mb-4 bg-light mt-3">

                                    <div class="card-body text-start ps-5 pb-2 ">
                                        <h4 class="text-primary"> Customer Information</h4>
                                        <strong style="font-weight: 700; font-size:medium"> {{userInfo.name}}</strong>
                                        <br>
                                        <span>
                                            Address:{{userInfo.address}}
                                        </span> <br>
                                        <span>
                                            Email:
                                            <a href="#" class="text-decoration-underline"
                                                target="_blank">{{userInfo.email}}</a> <i
                                                class="bi bi-box-arrow-up-right"></i>
                                        </span> <br>
                                        <span>
                                            Phone Number:{{userInfo.phone}}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {{> footers/page_footer}}

    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script>
        $(document).ready(function () {
            $("#payment_btn").on("click", function () {
                handlePayment();
            });
            function handlePayment() {
                // Lấy giá trị của radio button được chọn
                var paymentMethod = $("input[name='payment-method']:checked").val();
                // Tạo đối tượng dữ liệu để gửi đi (có thể tùy chỉnh theo yêu cầu của bạn)
                if (paymentMethod === "cash") {
                    var data = {
                        id: {{ orderInfo.OrderID }},
                        status: "unpaid",
                    };
                    $.ajax({
                        type: "GET",
                        url: "/order/updatestatus",
                        data: data,
                        success: function (response) {
                                                      console.log("1.a");
                            window.location.reload();
                        },
                        error: function (error) {
                            // Xử lý lỗi 
                        }
                    });
                }
                if (paymentMethod === "transact") {      
                    const userId = {{ userID }};
                    const totalMoney =  {{ orderInfo.Total }};
                    let code;
                    $.ajax({
                        url: "/api/check-account?userId=" + userId + "&totalMoney=" + totalMoney,
                        type: "GET",
                        success: function (res) {
                            console.log("1.b");
                            if(res.accountId){
                                alert("Successfully check account");
                                const accountId = res.accountId;
                          console.log("1.c");
                                // show password input
                                $("#password").parent().removeClass("d-none");
                                $("#password").focus();
                                $("#confirmPayment").click(function () {
                                    $.ajax({
                                        url: "/api/payment",
                                        type: "POST",
                                        data: {
                                            accountId: accountId,
                                            totalMoney,
                                            password: $("#password").val()
                                        }, 
                                        success: function (data) {
                                                                      console.log("1.d");
                                            alert(data.data .transactionCode)
                                            code  = data.data.transactionCode;
                                             var update_data = {
                                                id: {{ orderInfo.OrderID }},
                                                total: {{ orderInfo.Total }},
                                                status: "confirmed",
                                                tCode: code || 0
                                            };
                                            $.ajax({
                                                type: "GET",
                                                url: "/order/updatestatus",
                                                data: update_data,
                                                success: function (response) {
                                                                              console.log("1.e");
                                                    window.location.reload();
                                                },
                                                error: function (error) {
                                                    alert("reloadfailed")
                                                }
                                            });
                                        },
                                        error: function (data) {
                                            alert("Error " + data.error);
                                        }
                                    })
                                });
                            } else {
                                alert("Failed");
                            }
                        },
                        error: function (res) {
                            alert("Error " + res.error);
                        }
                    });

                }
            }
        });
    </script>

</body>
</html>