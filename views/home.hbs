<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
</head>
<body>
    <div class="row justify-content-center">
        <div class="col-4">
            <div class="card">
                <div class="card-header">User info</div>
                <div class="card-body">
                    <form method="post" id="user">
                        <input type="text" name="userId" value="1" readonly>
                        <input type="text" name="username" value="test" readonly>
                    </form>
                </div>
            </div>
            <div class="pay-demo mt-4">
                <h3>Demo client</h3>
                <label for="exampleAmount">Input order amount</label>
                <form method="post" id="payForm">
                    <input type="number" class="form-control" name="totalMoney">
                    <input type="text" name="userId" value="1" hidden>
                </form>
                <button type="button" class="btn btn-primary mt-4" id="payBtn">
                    Pay by <div class="badge bg-success">SkullPay</div>
                </button>
                <div class="d-flex flex-row mt-4">
                    <p>No payment account? </p> <button id="createAccBtn" class="btn btn-warning ms-4">Create one</button>
                </div>
                <p>Created account will have the same username</p>
            </div>
            <div class="d-none">
                <label for="password">Password for payment account</label>
                <input type="password" name="password" id="password">
                <button id="confirmPayment">Confirm</button>
            </div>
            <div id="msg">
            </div>
        </div>
    </div>
</body>

<script>
    const PAYMENT_SYS_URL = "http://localhost:5001";
    $(document).ready(function () {
        $("#payBtn").click(function () {
            const userId = $("#user").find("input[name='userId']").val();
            const totalMoney = $("#payForm").find("input[name='totalMoney']").val();
            console.log(userId, totalMoney)
            $.ajax({
                url: "/api/check-account?userId=" + userId + "&totalMoney=" + totalMoney,
                type: "GET",
                success: function (res) {
                    if(res.accountId ){
                        alert("Successfully check account");
                        const accountId = res.accountId;
                        // show password input
                        $("#password").parent().removeClass("d-none");
                        $("#password").focus();
                        $("#confirmPayment").click(function () {
                            $.ajax({
                                url: "/api/payment",
                                type: "POST",
                                data: {
                                    accountId: accountId,
                                    password: $("#password").val()
                                },
                                success: function (data) {
                                    if(data.msg === 'Successfully'){
                                        alert("Payment Successfully");
                                    } else {
                                        alert("Failed");
                                    }
                                },
                                error: function (data) {
                                    alert("Error " + data.error);
                                }
                            })
                        });
                    } else {
                        alert("Failed");
                    }
                },
                error: function (data) {
                    alert("Error" + data.error);
                }
            })
        });

        $("#createAccBtn").click(function () {
            $.ajax({
                url: "/api/create-account",
                type: "POST",
                data: $("#user").serialize(),
                success: function (res) {
                    if(res.accountId){
                        alert("Create account successfully");
                    } else {
                        alert("Failed, your account already exists");
                    }
                },
                error: function (data) {
                    alert("Error" + data.msg);
                }
            })
        });
    });

</script>
</html>